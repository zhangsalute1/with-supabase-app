# Todo 应用图片上传功能指南

本文档介绍了Todo应用中的图片上传功能实现和Supabase存储桶的配置要求。

## 功能概述

1. 用户可以为每个Todo任务添加一张图片作为附件
2. 图片保存在Supabase存储中，每个用户的图片存储在以其用户ID命名的文件夹中
3. 图片URL保存在数据库中，以便在任务列表中显示

## Supabase 配置要求

### 1. 创建存储桶

确保在Supabase中创建名为`my-todo`的存储桶：

1. 登录Supabase管理控制台
2. 进入"Storage"选项卡
3. 点击"New Bucket"按钮
4. 输入名称`my-todo`并选择适当的权限设置

### 2. 设置存储桶权限

为了使上传的图片可以被正确访问，需要设置以下权限：

1. 在Supabase控制台中，进入"Storage" > "Policies"
2. 为`my-todo`存储桶添加以下策略：

**针对插入(Insert)操作的策略**：

```sql
(auth.uid() = storage.foldername(name))
```

这确保用户只能上传文件到以自己ID命名的文件夹中。

**针对选择(Select)操作的策略**：

```sql
(bucket_id = 'my-todo')
```

这允许公开访问`my-todo`存储桶中的所有文件，使得图片可以在Todo列表中显示。

或者，使用这个策略以限制只有经过身份验证的用户才能查看图片：

```sql
(auth.role() = 'authenticated')
```

### 3. 存储桶设置

在Supabase控制台中：

1. 进入"Storage" > "Buckets" > "my-todo"
2. 确保"Public Bucket"选项已启用，以便图片可以公开访问

## 数据库表修改

为支持图片上传功能，我们在`todos`表中添加了`image_url`字段：

```sql
ALTER TABLE todos ADD COLUMN IF NOT EXISTS image_url TEXT;
```

此字段用于存储上传图片的公共URL。

## 前端实现

### 界面元素

1. **图片选择器**：允许用户从其设备中选择图片
2. **图片预览**：显示所选图片的预览
3. **取消按钮**：允许用户取消已选择的图片
4. **图片显示**：在任务列表中显示上传的图片

### 图片上传流程

1. 用户选择图片文件
2. 应用程序创建预览并显示
3. 用户提交任务表单时：
   - 首先将图片上传到Supabase存储
   - 获取上传图片的公共URL
   - 将任务信息和图片URL一起保存到数据库
   - 清除图片选择和预览

## 注意事项

1. **文件名唯一性**：为避免文件名冲突，我们使用随机字符串和时间戳生成唯一的文件名
2. **文件类型验证**：前端只允许用户选择图片文件
3. **资源清理**：当用户取消选择或提交表单后，会释放用于预览的资源

## 故障排除

如果图片上传或显示出现问题，请检查：

1. Supabase存储桶权限配置是否正确
2. 浏览器控制台是否有错误信息
3. 网络请求中是否有与存储相关的错误
4. 用户是否有足够的权限访问存储桶

## 扩展建议

未来可考虑添加的功能：

1. 图片裁剪和调整大小
2. 支持多图片上传
3. 图片压缩以减少存储空间和加载时间
4. 图片编辑功能
